apiVersion: external-secrets.io/v1alpha1
kind: ExternalSecret
metadata:
  name: {{.Release.Name}}-external-secret
  labels:
    {{- include "monitor.labels" . | nindent 4 }}
spec:
  secretStoreRef:
    name: {{ include "monitor.cluster-secret-store.name" . }}
    kind: ClusterSecretStore
  refreshInterval: "1h"
  # The secret that will be created
  target:
    name: {{.Release.Name}}-secret
    template:
      type: Opaque
      metadata:
        labels:
          {{- include "monitor.labels" . | nindent 10 }}
      data:
        .env: |-
          ENVIRONMENT={{ .Values.monitor.environment }}
{{/*
   * For each network, create an environment variable of the form: NETWORKNAME_RPC={{ .networkname_rpc }}
   * The templating of external-secrets will use the data section below to know how to replace the correct
   * in the created secret.
   */}}
{{ range $network := .Values.monitor.networks }}
{{ printf "%s_RPC='{{ .%s_rpc | toString }}'" (upper $network) $network | indent 10 }}
{{- end }}
  data:
{{/*
   * For each network, load the secret in GCP secret manager with the form: environment-rpc-endpoint-network,
   * and associate it with the secret key networkname_rpc.
   */}}
{{ range $network := .Values.monitor.networks }}
  - secretKey: {{ printf "%s_rpc" $network }}
    remoteRef:
      key: {{ printf "%s-rpc-endpoint-%s" $.Values.monitor.environment $network }}
{{- end }}